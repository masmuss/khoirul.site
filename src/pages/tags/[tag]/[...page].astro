---
export const prerender = true;

import type { CollectionEntry } from "astro:content";
import type { GetStaticPaths, Page } from "astro";
import Pagination from "@/components/Paginator.astro";
import PostPreview from "@/components/post/PostPreview.astro";
import PageLayout from "@/layouts/BaseLayout.astro";
import { getAllPosts, getUniqueTags, sortPostsByDate } from "@/lib/utils";

export const getStaticPaths: GetStaticPaths = async ({ paginate }) => {
	const allPosts = await getAllPosts();
	const allPostsByDate = [...allPosts].sort(sortPostsByDate);
	const uniqueTags = getUniqueTags(allPostsByDate);

	return uniqueTags.flatMap((tag) => {
		const filterPosts = allPostsByDate.filter((post) => post.data.tags.includes(tag));
		return paginate(filterPosts, {
			pageSize: 10,
			params: { tag },
		});
	});
};

interface Props {
	page: Page<CollectionEntry<"post">>;
}

const { page } = Astro.props;
const { tag } = Astro.params;

const paginationProps = {
	...(page.url.prev && {
		prevUrl: {
			text: "← Previous Posts",
			url: page.url.prev,
		},
	}),
	...(page.url.next && {
		nextUrl: {
			text: "Next Posts →",
			url: page.url.next,
		},
	}),
};
---

<PageLayout
	title=`Tag: ${tag}`
	description=`View all posts with the tag - ${tag}`
	pageType="website"
>
	<div class="flex w-full flex-col gap-y-8">
		<div class="flex w-full flex-col">
			<h1 class="mb-4 text-2xl font-semibold">Tag: {tag}</h1>

			<div class="flex items-center gap-3">
				<a
					href="/tags"
					class="text-muted-foreground hover:text-foreground text-sm transition-colors"
				>
					← All Tags
				</a>
				<span class="text-muted-foreground/50">|</span>
				<span class="text-muted-foreground text-sm">
					{page.total} post{page.total > 1 ? "s" : ""}
				</span>
			</div>
		</div>

		<section aria-label="Blog post list">
			<ul class="group/list flex flex-col">
				{page.data.map((p) => <PostPreview post={p} />)}
			</ul>
			<Pagination {...paginationProps} />
		</section>
	</div>
</PageLayout>
